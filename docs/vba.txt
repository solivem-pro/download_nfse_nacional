Option Explicit

' ===============================
' Sub principal de importação
' ===============================
Sub ImportarTodosXMLs()
    Dim pastaBase As String
    Dim fso As Object, pasta As Object
    
    pastaBase = ThisWorkbook.Path
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set pasta = fso.GetFolder(pastaBase)
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    Application.Calculation = xlCalculationManual
    
    ' Limpa tabelas antes de importar
    LimparTabela ThisWorkbook.Sheets("PRESTADOS").ListObjects("NFSE_PRESTADOS")
    LimparTabela ThisWorkbook.Sheets("TOMADOS").ListObjects("NFSE_TOMADOS")
    LimparTabela ThisWorkbook.Sheets("EVENTOS").ListObjects("NFSE_EVENTO")
    
    ' Importa todos os XMLs
    ImportarDaPasta pasta
    
    ' Formatar as tabelas
    FormatarTabelas

    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    Application.EnableEvents = True
End Sub

' ===============================
' Função recursiva para percorrer pastas
' ===============================
Private Function ImportarDaPasta(ByVal pasta As Object) As Long
    Dim arq As Object, subPasta As Object
    Dim count As Long
    
    count = 0
    For Each arq In pasta.Files
        If LCase(Right(arq.Name, 4)) = ".xml" Then
            count = count + ImportarXML(arq.Path)
        End If
    Next arq
    
    For Each subPasta In pasta.SubFolders
        count = count + ImportarDaPasta(subPasta)
    Next subPasta
    
    ImportarDaPasta = count
End Function

' ===============================
' Função para obter caminho relativo do PDF
' ===============================
Private Function CaminhoRelativoPDF(ByVal caminhoXML As String) As String
    Dim fso As Object, pastaPlanilha As Object
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set pastaPlanilha = fso.GetFolder(ThisWorkbook.Path)
    
    Dim nomeBase As String, caminhoPDF As String
    nomeBase = fso.GetBaseName(caminhoXML)
    
    ' Tenta no mesmo diretório primeiro
    caminhoPDF = Left(caminhoXML, Len(caminhoXML) - 3) & "pdf"
    
    If Not fso.FileExists(caminhoPDF) Then
        caminhoPDF = BuscarPDFRecursivo(pastaPlanilha, nomeBase)
    End If
    
    If caminhoPDF <> "" Then
        CaminhoRelativoPDF = Mid(caminhoPDF, Len(ThisWorkbook.Path) + 2)
    Else
        CaminhoRelativoPDF = ""
    End If
End Function

' ===============================
' Função recursiva para encontrar PDF
' ===============================
Private Function BuscarPDFRecursivo(ByVal pasta As Object, ByVal nomeBase As String) As String
    Dim arq As Object, subPasta As Object
    
    For Each arq In pasta.Files
        If LCase(Right(arq.Name, 4)) = ".pdf" And _
           LCase(Left(arq.Name, Len(arq.Name) - 4)) = LCase(nomeBase) Then
            BuscarPDFRecursivo = arq.Path
            Exit Function
        End If
    Next arq
    
    For Each subPasta In pasta.SubFolders
        Dim resultado As String
        resultado = BuscarPDFRecursivo(subPasta, nomeBase)
        If resultado <> "" Then
            BuscarPDFRecursivo = resultado
            Exit Function
        End If
    Next subPasta
    
    BuscarPDFRecursivo = ""
End Function

' ===============================
' Importa XML individual
' ===============================
Private Function ImportarXML(ByVal caminhoXML As String) As Long
    Dim xmlDoc As Object, inf As Object, evtNodes As Object
    Dim alvoCNPJ As String, prestCNPJ As String, tomaCNPJ As String
    Dim dataSemHora As String, competencia As String, chaveNFSE As String, caminhoPDF As String
    Dim count As Long
    
    On Error GoTo ErrHandler
    
    Set xmlDoc = CreateObject("MSXML2.DOMDocument.6.0")
    xmlDoc.async = False
    If Not xmlDoc.Load(caminhoXML) Then Exit Function
    
    alvoCNPJ = Trim(ThisWorkbook.Sheets("alvo").Range("A1").Value)
    If alvoCNPJ = "" Then Exit Function
    
    caminhoPDF = CaminhoRelativoPDF(caminhoXML)
    Set inf = xmlDoc.SelectSingleNode("//*[local-name()='infNFSe']")
    
    If Not inf Is Nothing Then
        dataSemHora = ExtrairData(ValorDoNo(inf, "*[local-name()='dhProc']"))
        competencia = ExtrairData(ValorDoNo(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='dCompet']"))
        chaveNFSE = ExtrairChaveNFSE(ValorDoAtributo(inf, "Id"))
        
        prestCNPJ = ValorDoCNPJouCPF(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='prest']")
        tomaCNPJ = ValorDoCNPJouCPF(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='toma']")
        
        If prestCNPJ = alvoCNPJ Then
            InserirLinhaNFSe inf, dataSemHora, competencia, chaveNFSE, caminhoPDF, "P"
            count = count + 1
        End If
        
        If tomaCNPJ = alvoCNPJ Then
            InserirLinhaNFSe inf, dataSemHora, competencia, chaveNFSE, caminhoPDF, "T"
            count = count + 1
        End If
    End If
    
    Set evtNodes = xmlDoc.SelectNodes("//*[local-name()='infEvento']")
    If Not evtNodes Is Nothing Then
        Dim evt As Object
        For Each evt In evtNodes
            If InserirLinhaEvento(evt, alvoCNPJ, caminhoPDF) Then count = count + 1
        Next evt
    End If
    
    ImportarXML = count
    Exit Function
    
ErrHandler:
    ImportarXML = 0
End Function

' ===============================
' Função unificada para inserir Prestados/Tomados
' ===============================
Private Sub InserirLinhaNFSe(ByVal inf As Object, ByVal dataSemHora As String, _
                            ByVal competencia As String, ByVal chaveNFSE As String,  _
                            ByVal caminhoPDF As String, ByVal tipo As String)
    On Error GoTo ErrHandler
    
    Dim ws As Worksheet, tbl As ListObject
    Set ws = ThisWorkbook.Sheets(IIf(tipo = "P", "PRESTADOS", "TOMADOS"))
    Set tbl = ws.ListObjects(IIf(tipo = "P", "NFSE_PRESTADOS", "NFSE_TOMADOS"))
    
    With tbl.ListRows.Add
        .Range(1, 1).Value = ValorDoNo(inf, "*[local-name()='nNFSe']")
        .Range(1, 2).Value = dataSemHora
        .Range(1, 3).Value = competencia
        .Range(1, 4).Value = ValorDoNo(inf, "*[local-name()='xLocIncid']")
        .Range(1, 5).Value = ValorDoCNPJouCPF(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='prest']")
        .Range(1, 6).Value = NomePrestadorComFallback(inf)
        .Range(1, 7).Value = ValorDoCNPJouCPF(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='toma']")
        .Range(1, 8).Value = ValorDoNo(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='toma']/*[local-name()='xNome']")
        .Range(1, 9).Value = ValorDoNo(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='serv']/*[local-name()='cServ']/*[local-name()='cTribNac']")
        .Range(1, 10).Value = ValorDoNo(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='serv']/*[local-name()='cServ']/*[local-name()='cNBS']")
        .Range(1, 11).Value = ValorDoNo(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='serv']/*[local-name()='cServ']/*[local-name()='xDescServ']")
        .Range(1, 12).Value = ValorDoNo(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='valores']/*[local-name()='vServPrest']/*[local-name()='vServ']")
        .Range(1, 13).Value = ValorDoNo(inf, "*[local-name()='valores']/*[local-name()='vTotalRet']")
        .Range(1, 14).Value = ValorDoNo(inf, "*[local-name()='valores']/*[local-name()='vLiq']")

        AplicarHyperlink .Range(1, 15), caminhoPDF, chaveNFSE

    End With
    Exit Sub
    
ErrHandler:
    ' Erro silencioso
End Sub

' ===============================
' Inserir linha na tabela EVENTOS
' ===============================
Private Function InserirLinhaEvento(ByVal evt As Object, ByVal alvoCNPJ As String, ByVal caminhoPDF As String) As Boolean
    On Error GoTo ErrHandler
    
    Dim tbl As ListObject
    Set tbl = ThisWorkbook.Sheets("EVENTOS").ListObjects("NFSE_EVENTO")
    Dim novaLinha As ListRow
    Set novaLinha = tbl.ListRows.Add
    
    Dim cnpjAutor As String, tipoEvento As String
    Dim nDFe As String, dataSemHora As String, dhProc As String
    Dim xDesc As String, xMotivo As String, chNFSe As String
    
    nDFe = ValorDoNo(evt, "*[local-name()='nDFe']")
    dhProc = ValorDoNo(evt, "*[local-name()='dhProc']")
    dataSemHora = ExtrairData(dhProc)
    
    Dim cnpjAutorNode As Object
    Set cnpjAutorNode = evt.SelectSingleNode("*[local-name()='pedRegEvento']/*[local-name()='infPedReg']/*[local-name()='CNPJAutor']")
    If Not cnpjAutorNode Is Nothing Then cnpjAutor = Trim(cnpjAutorNode.Text)
    
    xDesc = BuscarPrimeiraOcorrencia(evt, "*[local-name()='pedRegEvento']/*[local-name()='infPedReg']", "xDesc")
    xMotivo = BuscarPrimeiraOcorrencia(evt, "*[local-name()='pedRegEvento']/*[local-name()='infPedReg']", "xMotivo")
    
    Dim chNFSeNode As Object
    Set chNFSeNode = evt.SelectSingleNode("*[local-name()='pedRegEvento']/*[local-name()='infPedReg']/*[local-name()='chNFSe']")
    If Not chNFSeNode Is Nothing Then chNFSe = Trim(chNFSeNode.Text)
    
    tipoEvento = IIf(cnpjAutor = alvoCNPJ, "Prestador", "Tomador")
    
    With novaLinha
        .Range(1, 1).Value = nDFe
        .Range(1, 2).Value = dataSemHora
        .Range(1, 3).Value = cnpjAutor
        .Range(1, 4).Value = tipoEvento
        .Range(1, 5).Value = xDesc
        .Range(1, 6).Value = xMotivo
        AplicarHyperlink .Range(1, 7), caminhoPDF, chNFSe
    End With
    
    InserirLinhaEvento = True
    Exit Function
    
ErrHandler:
    InserirLinhaEvento = False
End Function

' ===============================
' Aplicar hyperlink unificado
' ===============================
Private Sub AplicarHyperlink(ByVal celula As Range, ByVal caminhoPDF As String, ByVal texto As String)
    On Error Resume Next
    celula.Value = texto
    celula.Hyperlinks.Delete
    
    If caminhoPDF <> "" Then
        celula.Worksheet.Hyperlinks.Add _
            Anchor:=celula, _
            Address:=caminhoPDF, _
            TextToDisplay:=texto, _
            ScreenTip:="Clique para abrir o PDF: " & caminhoPDF
        
        With celula.Font
            .Color = RGB(0, 50, 180)
            .Underline = xlUnderlineStyleSingle
        End With
    Else
        With celula.Font
            .Color = RGB(0, 0, 0)
            .Underline = xlUnderlineStyleNone
        End With
    End If
End Sub

' ===============================
' Funções auxiliares
' ===============================
Private Function ExtrairData(ByVal dhProc As String) As String
    If InStr(dhProc, "T") > 0 Then
        ExtrairData = Split(dhProc, "T")(0)
    Else
        ExtrairData = dhProc
    End If
End Function

Private Function ExtrairChaveNFSE(ByVal Id As String) As String
    If Id = "" Then
        ExtrairChaveNFSE = "SemChave"
    ElseIf InStr(Id, "NFS") > 0 Then
        ExtrairChaveNFSE = Replace(Id, "NFS", "")
    Else
        ExtrairChaveNFSE = Id
    End If
End Function

Private Function BuscarPrimeiraOcorrencia(ByVal evt As Object, ByVal caminhoBase As String, ByVal campo As String) As String
    On Error Resume Next
    Dim resultado As String
    resultado = ValorDoNo(evt, caminhoBase & "/*[local-name()='e101101']/*[local-name()='" & campo & "']")
    
    If resultado = "" Then
        Dim nodes As Object
        Set nodes = evt.SelectNodes(caminhoBase & "/*/*[local-name()='" & campo & "']")
        If Not nodes Is Nothing Then
            If nodes.Length > 0 Then resultado = Trim(nodes(0).Text)
        End If
    End If
    
    BuscarPrimeiraOcorrencia = resultado
End Function

Private Sub LimparTabela(tbl As ListObject)
    On Error Resume Next
    If tbl.ListRows.count > 0 Then tbl.DataBodyRange.Delete
End Sub

Private Function ValorDoNo(ByVal raiz As Object, ByVal caminho As String) As String
    On Error Resume Next
    Dim no As Object
    Set no = raiz.SelectSingleNode(caminho)
    If Not no Is Nothing Then ValorDoNo = Trim(no.Text) Else ValorDoNo = ""
End Function

Private Function ValorDoAtributo(ByVal no As Object, ByVal nomeAtributo As String) As String
    On Error Resume Next
    If Not no Is Nothing Then ValorDoAtributo = no.getAttribute(nomeAtributo) Else ValorDoAtributo = ""
End Function

Private Function ValorDoCNPJouCPF(ByVal raiz As Object, ByVal caminhoBase As String) As String
    On Error Resume Next
    Dim no As Object
    Set no = raiz.SelectSingleNode(caminhoBase & "/*[local-name()='CNPJ']")
    If Not no Is Nothing Then
        ValorDoCNPJouCPF = Trim(no.Text)
        Exit Function
    End If
    Set no = raiz.SelectSingleNode(caminhoBase & "/*[local-name()='CPF']")
    If Not no Is Nothing Then ValorDoCNPJouCPF = Trim(no.Text) Else ValorDoCNPJouCPF = ""
End Function

Private Function NomePrestadorComFallback(ByVal inf As Object) As String
    On Error Resume Next
    Dim nome As String
    nome = ValorDoNo(inf, "*[local-name()='DPS']/*[local-name()='infDPS']/*[local-name()='prest']/*[local-name()='xNome']")
    If nome = "" Then nome = ValorDoNo(inf, "*[local-name()='emit']/*[local-name()='xNome']")
    NomePrestadorComFallback = nome
End Function

Private Sub FormatarTabelas()
    On Error Resume Next
    Dim arrSheets, sheetName
    
    arrSheets = Array("PRESTADOS", "TOMADOS", "EVENTOS")
    
    For Each sheetName In arrSheets
        With ThisWorkbook.Sheets(sheetName)
            .Cells.Font.Name = "Consolas"
            .Cells.Font.Size = 9
            .ListObjects(1).HeaderRowRange.Font.Size = 10
        End With
    Next
End Sub